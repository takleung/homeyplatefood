{{ define "main" }}
<article class="recipe-single">
    <div class="container">
        <div class="recipe-header">
            <h1 class="recipe-single-title">{{ .Title }}</h1>
            <div class="recipe-meta-bar">
                <time datetime="{{ .Date.Format "2006-01-02" }}" class="recipe-date">
                    {{ .Date.Format "January 2, 2006" }}
                </time>
            </div>
        </div>

        {{ with .Resources.GetMatch "*.{jpg,jpeg,png,gif,webp}" }}
        <div class="recipe-hero-image">
            <a href="{{ .Permalink }}" class="lightbox-trigger" data-lightbox="gallery" title="Click to view high-res">
                <img src="{{ .Permalink }}" alt="{{ $.Title }}" loading="eager">
                <span class="view-highres">Click to view high-res</span>
            </a>
        </div>
        {{ end }}

        <div class="recipe-body">
            {{ .Content }}
        </div>

        <!-- Image Gallery -->
        {{ $images := .Resources.Match "*.{jpg,jpeg,png,gif,webp}" }}
        {{ if gt (len $images) 1 }}
        <div class="recipe-gallery">
            <h2>Gallery</h2>
            <div class="gallery-grid">
                {{ range $images }}
                    {{ if not .Params.cover }}
                    <div class="gallery-item">
                        <a href="{{ .Permalink }}" class="lightbox-trigger" data-lightbox="gallery" title="Click to view high-res">
                            <img src="{{ .Permalink }}" alt="{{ $.Title }}" loading="lazy">
                            <span class="view-highres">View high-res</span>
                        </a>
                    </div>
                    {{ end }}
                {{ end }}
            </div>
        </div>
        {{ end }}

        <div class="recipe-navigation">
            {{ with .PrevInSection }}
            <a href="{{ .Permalink }}" class="nav-link nav-prev">
                <span class="nav-label">← Previous Recipe</span>
                <span class="nav-title">{{ .Title }}</span>
            </a>
            {{ end }}
            <a href="/" class="nav-link nav-home">
                <span class="nav-label">← Back to Gallery</span>
            </a>
            {{ with .NextInSection }}
            <a href="{{ .Permalink }}" class="nav-link nav-next">
                <span class="nav-label">Next Recipe →</span>
                <span class="nav-title">{{ .Title }}</span>
            </a>
            {{ end }}
        </div>
    </div>
</article>

<!-- Lightbox Modal -->
<div id="lightbox" class="lightbox-overlay">
    <button class="lightbox-close" aria-label="Close">&times;</button>
    <button class="lightbox-prev" aria-label="Previous">&#10094;</button>
    <button class="lightbox-next" aria-label="Next">&#10095;</button>
    <div class="lightbox-content">
        <img id="lightbox-img" src="" alt="">
    </div>
</div>

<style>
/* Clickable image styling */
.recipe-hero-image a,
.gallery-item a {
    display: block;
    position: relative;
    cursor: zoom-in;
}

.recipe-hero-image a:hover img,
.gallery-item a:hover img {
    opacity: 0.9;
    transition: opacity 0.2s ease;
}

.view-highres {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    border-radius: 4px;
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
}

.recipe-hero-image a:hover .view-highres,
.gallery-item a:hover .view-highres {
    opacity: 1;
}

/* Lightbox styles */
.lightbox-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    justify-content: center;
    align-items: center;
}

.lightbox-overlay.active {
    display: flex;
}

.lightbox-content {
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

.lightbox-content img {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 4px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
}

.lightbox-close {
    position: absolute;
    top: 20px;
    right: 30px;
    font-size: 2.5rem;
    color: white;
    background: none;
    border: none;
    cursor: pointer;
    z-index: 10000;
    opacity: 0.8;
    transition: opacity 0.2s;
}

.lightbox-close:hover {
    opacity: 1;
}

.lightbox-prev,
.lightbox-next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 2rem;
    color: white;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    cursor: pointer;
    padding: 1rem;
    border-radius: 4px;
    opacity: 0.7;
    transition: opacity 0.2s, background 0.2s;
}

.lightbox-prev:hover,
.lightbox-next:hover {
    opacity: 1;
    background: rgba(255, 255, 255, 0.2);
}

.lightbox-prev {
    left: 20px;
}

.lightbox-next {
    right: 20px;
}

/* Hide nav buttons if only one image */
.lightbox-overlay.single-image .lightbox-prev,
.lightbox-overlay.single-image .lightbox-next {
    display: none;
}
</style>

<script>
(function() {
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const triggers = document.querySelectorAll('.lightbox-trigger');
    const closeBtn = document.querySelector('.lightbox-close');
    const prevBtn = document.querySelector('.lightbox-prev');
    const nextBtn = document.querySelector('.lightbox-next');

    let currentIndex = 0;
    let images = [];

    // Collect all gallery images
    triggers.forEach((trigger, index) => {
        images.push(trigger.href);

        trigger.addEventListener('click', function(e) {
            e.preventDefault();
            currentIndex = index;
            openLightbox(this.href);
        });
    });

    function openLightbox(src) {
        lightboxImg.src = src;
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Toggle nav buttons visibility
        if (images.length <= 1) {
            lightbox.classList.add('single-image');
        } else {
            lightbox.classList.remove('single-image');
        }
    }

    function closeLightbox() {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
    }

    function showPrev() {
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        lightboxImg.src = images[currentIndex];
    }

    function showNext() {
        currentIndex = (currentIndex + 1) % images.length;
        lightboxImg.src = images[currentIndex];
    }

    // Event listeners
    closeBtn.addEventListener('click', closeLightbox);
    prevBtn.addEventListener('click', showPrev);
    nextBtn.addEventListener('click', showNext);

    // Close on background click
    lightbox.addEventListener('click', function(e) {
        if (e.target === lightbox || e.target === document.querySelector('.lightbox-content')) {
            closeLightbox();
        }
    });

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (!lightbox.classList.contains('active')) return;

        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') showPrev();
        if (e.key === 'ArrowRight') showNext();
    });
})();
</script>
{{ end }}
